humhub.module("calendar",function(i,t,o){var r=t("ui.widget").Widget,a=t("client"),u=(t("util").object,t("ui.modal")),c=t("action"),n=t("content").Content,d=t("event"),l=t("stream").StreamEntry,s=r.extend(),p=r.extend();p.RECUR_EDIT_MODE_CREATE=0,p.RECUR_EDIT_MODE_THIS=1,p.RECUR_EDIT_MODE_FOLLOWING=2,p.RECUR_EDIT_MODE_ALL=3,p.prototype.init=function(){var r="#calendarentryform-start_",a="#calendarentryform-end_";function c(){return{startDate:o(r+"date").datepicker("getDate").getTime(),endDate:o(a+"date").datepicker("getDate").getTime(),arrStart:o(r+"time").val().split(":"),arrEnd:o(a+"time").val().split(":")}}function d(t,e){return+e[0]<=+t[0]&&e[1].includes("A")&&(t[1].includes("A")||t[1].includes("P"))||e[1].includes("P")&&t[1].includes("P")}function l(t,e){return e?t.includes("A")?t.replace("A","P"):t.replace("P","A"):t.includes("A")?t.replace("P","A"):t.replace("A","P")}function s(t,e){e[0]=(e[0]<=9?"0":"")+e[0],o(t+"time").val(e.join(":"))}u.global.$.find(".tab-basic").on("shown.bs.tab",function(t){o("#calendarentry-title").focus()}),u.global.$.find(".tab-participation").on("shown.bs.tab",function(t){o("#calendarentry-participation_mode").focus()}),this.$.find(r+"time").on("change",function(){var t=c(),e=t.startDate,n=t.endDate,i=t.arrStart,o=t.arrEnd;e===n&&(i[1].includes("M")?"11"===o[0]&&o[1].includes("P")||d(i,o)&&(o[0]=12==+i[0]?1:+i[0]+1,o[1]=l(i[1],11==+i[0]),s(a,o)):+o[0]<=+i[0]&&(o[0]="23"===i[0]?"23"!==o[0]?0:+o[0]:+i[0]+1,s(a,o)))}),this.$.find(a+"time").on("change",function(){var t=c(),e=t.startDate,n=t.endDate,i=t.arrStart,o=t.arrEnd;e===n&&(i[1].includes("M")?"12"===i[0]&&i[1].includes("A")||d(i,o)&&(i[0]=1==+o[0]?12:o[0]-1,i[1]=l(o[1],12==+o[0]),s(r,i)):+o[0]<=+i[0]&&(i[0]=0==+o[0]?0!=+i[0]?23:+i[0]:o[0]-1,s(r,i)))}),this.$.find(r+"date").on("change",function(){var t=o(r+"date").datepicker("getDate").getTime();o(a+"date").datepicker("getDate").getTime()<t&&o(a+"date").val(o(r+"date").val())}),this.$.find(a+"date").on("change",function(){var t=o(r+"date").datepicker("getDate").getTime();o(a+"date").datepicker("getDate").getTime()<t&&o(r+"date").val(o(a+"date").val())}),this.initTimeInput(),this.initSubmitAction()},p.prototype.setEditMode=function(t){var e=t.$trigger.data("editMode");e==p.RECUR_EDIT_MODE_THIS?o(".field-calendarentryform-is_public").hide():o(".field-calendarentryform-is_public").show(),this.$.find(".calendar-edit-mode-back").show(),this.$.find(".recurrence-edit-type").hide(),this.$.find(".calendar-entry-form-tabs").show(),this.$.find("#recurrenceEditMode").val(e)},p.prototype.showEditModes=function(t){this.$.find(".calendar-edit-mode-back").hide(),this.$.find(".recurrence-edit-type").show(),this.$.find(".calendar-entry-form-tabs").hide()},p.prototype.initTimeInput=function(t){u.global.$.find(".timeField").find(".form-control").each(function(){var t=o(this);t.prop("disabled")&&t.data("oldVal",t.val()).val("")})},p.prototype.initSubmitAction=function(){u.global.$.one("submitted",f)};var f=function(t,e){e.id&&u.global.$.one("hidden.bs.modal",function(){var t=l.getNodeByKey(e.id);t.length&&(t=new l(t)).reload()}),e.reloadWall?(d.trigger("humhub:content:newEntry",e.content,this),d.trigger("humhub:content:afterSubmit",e.content,this)):u.global.$.one("submitted",f)};p.prototype.toggleDateTime=function(t){var e=u.global.$.find(".timeField"),n=e.find(".form-control"),i=u.global.$.find(".timeZoneField");t.$trigger.prop("checked")?(n.prop("disabled",!0),n.each(function(){o(this).data("oldVal",o(this).val()).val("")}),e.css("opacity","0.2"),i.hide()):(n.each(function(){var t=o(this);t.data("oldVal")&&t.val(t.data("oldVal"))}),n.prop("disabled",!1),e.css("opacity","1.0"),i.show())},p.prototype.changeTimezone=function(t){var e=this.$.find(".timeZoneInput");this.$.find(".calendar-timezone").text(e.find("option:selected").text()),e.hide()},p.prototype.toggleTimezoneInput=function(t){this.$.find(".timeZoneInput").fadeToggle()},p.prototype.changeEventType=function(t){var e=t.$trigger.find(":selected");e.data("type-color")&&(o(".colorpicker-element").data("colorpicker").color.setColor(e.data("type-color")),o(".colorpicker-element").data("colorpicker").update())},p.prototype.toggleRecurring=function(t){o(".calendar-entry-form-tabs .tab-recurrence").parent().toggle(t.$trigger.is(":checked"))},p.prototype.toggleReminder=function(t){o(".calendar-entry-form-tabs .tab-reminder").parent().toggle(t.$trigger.is(":checked"))};var h=n.extend();h.prototype.toggleClose=function(t){this.update(a.post(t))},h.prototype.reload=function(t){return this.parent().reload()},h.prototype.update=function(t){this.loader(),t.then(o.proxy(this.handleUpdateSuccess,this)).catch(h.handleUpdateError).finally(o.proxy(this.loader,this,!1))},h.prototype.loader=function(t){this.streamEntry().loader(t)},h.prototype.handleUpdateSuccess=function(t){return this.streamEntry().replace(t.output).catch(function(t){i.log.error(t,!0)})},h.handleUpdateError=function(t){i.log.error(t,!0)},h.prototype.streamEntry=function(){return this.parent()};var g=function(){return r.instance("#calendar")};i.export({Calendar:s,respond:function(n){n.block=c.BLOCK_MANUAL,a.post(n).then(function(t){t.success?r.closest(n.$trigger).reload().then(function(){i.log.success("saved")}):(i.log.error(e,!0),n.finish())}).catch(function(t){i.log.error(t,!0),n.finish()})},editModal:function(t){r.closest(t.$trigger).loader(),u.load(t).then(function(t){u.global.$.one("submitted",function(){var t=g();t&&t.fetch()})}).catch(function(t){i.log.error(t,!0)})},deleteEvent:function(e){r.closest(e.$trigger).loader(),u.confirm().then(function(t){t?a.post(e).then(function(){u.global.close()}).catch(function(t){i.log.error(t,!0)}):r.closest(e.$trigger).loader(!1)}).finally(function(){e.finish()})},CalendarEntry:h,Form:p})});